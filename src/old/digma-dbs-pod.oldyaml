apiVersion: v1
kind: Pod
metadata:
  name: {{ .Release.Name }}-dbs
  labels:
    app/all-dbs: ""
    app/redis: ""
    app/rabbitmq: ""
    app/postgres: ""
    app/influxdb: ""
spec:
  containers:
    
    - name: redis
      image: redis:alpine
      volumeMounts:
      - name: redis-data
        mountPath: /data

    - name: rabbitmq
      image: rabbitmq:3-management-alpine
      volumeMounts:
      - name: rabbitmq-data
        mountPath: /var/lib/rabbitmq/
      - name: rabbitmq-log
        mountPath: /var/log/rabbitmq/
      env:
      - name: RABBITMQ_DEFAULT_USER
        value: {{ .Values.rabbit.username}}
      - name: RABBITMQ_DEFAULT_PASS
        value: {{ .Values.rabbit.password}}

    - name: postgres
      image: postgres
      volumeMounts:
      - name: postgres-data
        mountPath: /var/lib/postgresql/data
      env:
      - name: POSTGRES_NAME
        value: postgres
      - name: POSTGRES_USER
        value: {{ .Values.postgres.username}}
      - name: POSTGRES_PASSWORD
        value: {{ .Values.postgres.password}}

    - name: influxdb
      image: influxdb:latest
      volumeMounts:
      - name: influxdb-data
        mountPath: /var/lib/influxdb2
      - name: influxdb-config
        mountPath: /etc/influxdb2
      env:
      - name: DOCKER_INFLUXDB_INIT_MODE
        value: "setup"
      - name: DOCKER_INFLUXDB_INIT_USERNAME
        value: "admin"
      - name: DOCKER_INFLUXDB_INIT_PASSWORD
        value: "12345678"
      - name: DOCKER_INFLUXDB_INIT_ORG
        value: "digma"
      - name: DOCKER_INFLUXDB_INIT_BUCKET
        value: "errors"
      - name: DOCKER_INFLUXDB_INIT_RETENTION
        value: "24w"
      - name: DOCKER_INFLUXDB_INIT_ADMIN_TOKEN
        value: "dc61908e-05bc-411a-9fe2-e3356b8dc7c0"

  volumes:
  - name: redis-data
    emptyDir: {}
  - name: rabbitmq-data
    emptyDir: {}
  - name: rabbitmq-log
    emptyDir: {}
  - name: postgres-data
    emptyDir: {}
  - name: influxdb-data
    emptyDir: {}
  - name: influxdb-config
    emptyDir: {}